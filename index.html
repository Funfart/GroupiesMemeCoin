<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GMC Mini App — Market Watch & Voting</title>
<style>
  /* === Liquid Glass 2025 Design System === */
  :root {
    --bg: #070b1a;
    --card: rgba(255, 255, 255, 0.08);
    --muted: rgba(255, 255, 255, 0.7);
    --accent: #7c3aed;
    --accent2: #06b6d4;
    --success: #10b981;
    --neon-glow: 0 0 25px rgba(124, 58, 237, 0.6), 0 0 45px rgba(6, 182, 212, 0.4);
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    scroll-behavior: smooth;
    color: #fff;
    overflow-x: hidden;
  }

  /* === Static background with parallax illusion === */
  body {
    background:
      linear-gradient(180deg, rgba(7,16,38,0.85) 0%, rgba(11,18,32,0.85) 100%),
      url('image.png') center center / cover no-repeat fixed;
    background-attachment: fixed;
    background-size: cover;
    background-position: center;
  }

  /* Soft global glass blur overlay for depth */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(22px) saturate(160%);
    -webkit-backdrop-filter: blur(22px) saturate(160%);
    z-index: -1;
  }

  /* Wrapper with soft fade-in motion */
  .wrap {
    max-width: 980px;
    margin: 24px auto;
    padding: 16px;
    animation: fadeIn 0.8s ease-out forwards;
  }

  /* === Liquid Glass Cards === */
.card {
  position: relative;
  background: var(--card);
  border-radius: 18px;
  padding: 16px;
  box-shadow:
    0 6px 25px rgba(0, 0, 0, 0.45),
    inset 0 0 1px rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(16px) saturate(160%);
  -webkit-backdrop-filter: blur(16px) saturate(160%);
  border: 1px solid rgba(255, 255, 255, 0.15);
  transform-style: preserve-3d;
  will-change: transform, box-shadow, border-color;
  transition:
    transform 0.6s cubic-bezier(0.19, 1, 0.22, 1),
    box-shadow 0.4s ease,
    border 0.3s ease,
    background 0.4s ease;
  overflow: hidden;
  z-index: 1;
}

/* === Soft glow following cursor === */
.card::before {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(
    circle at var(--glow-x, 50%) var(--glow-y, 50%),
    rgba(124, 58, 237, 0.18),
    rgba(6, 182, 212, 0.1),
    transparent 70%
  );
  opacity: 0;
  transition: opacity 0.3s ease, background 0.3s ease;
  pointer-events: none;
  z-index: 0;
}

.card:hover::before {
  opacity: 1;
}

/* === Dynamic reflection plane === */
.card::after {
  content: "";
  position: absolute;
  bottom: -60%;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    to bottom,
    rgba(124, 58, 237, 0.15),
    rgba(6, 182, 212, 0.05),
    transparent 90%
  );
  opacity: 0.35;
  transform: scaleY(-1) translateY(10%);
  filter: blur(20px);
  transition: opacity 0.4s ease, transform 0.4s ease;
  pointer-events: none;
  z-index: -1;
}

.card:hover::after {
  opacity: 0.5;
  transform: scaleY(-1) translateY(0);
}

/* === Hover effects === */
.card:hover {
  transform: translateY(-3px) scale(1.02);
  box-shadow:
    0 12px 40px rgba(0, 0, 0, 0.6),
    0 0 50px rgba(124, 58, 237, 0.25);
  border-color: rgba(255, 255, 255, 0.25);
  background: rgba(255, 255, 255, 0.1);
}
  /* === Header Elements === */
  .top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .logo {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    box-shadow: var(--neon-glow);
    animation: pulseGlow 4s ease-in-out infinite alternate;
  }

  .pill {
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  /* === Buttons === */
  .btn {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    color: #fff;
    padding: 10px 14px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.25s ease;
    box-shadow: 0 4px 14px rgba(124, 58, 237, 0.3);
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--neon-glow);
  }

  .btn.alt {
    background: rgba(255, 255, 255, 0.04);
    color: var(--muted);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .btn.alt:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
  }

  /* === Inputs === */
  input[type=number], input[type=text] {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 10px;
    color: #fff;
    width: 100%;
    transition: all 0.25s ease;
  }

  input[type=number]:focus, input[type=text]:focus {
    outline: none;
    border-color: var(--accent2);
    box-shadow: 0 0 12px rgba(6, 182, 212, 0.4);
  }

  /* === Typography === */
  .label {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.75);
  }

  .value {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.4px;
  }

  .small {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.75);
  }

  .muted {
    color: rgba(255, 255, 255, 0.6);
  }

  /* === Grid Layouts === */
  .grid {
    display: grid;
    gap: 14px;
  }

  .cols-3 { grid-template-columns: 1fr 360px 280px; }
  .cols-2 { grid-template-columns: 1fr 320px; }

  @media (max-width: 900px) {
    .cols-3, .cols-2 { grid-template-columns: 1fr; }
  }

  /* === Scrollbar styling === */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(var(--accent), var(--accent2));
    border-radius: 6px;
  }

  /* === Animations === */
  @keyframes pulseGlow {
    from { box-shadow: 0 0 10px rgba(124,58,237,0.4), 0 0 20px rgba(6,182,212,0.2); }
    to { box-shadow: 0 0 25px rgba(124,58,237,0.6), 0 0 45px rgba(6,182,212,0.4); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* === Subtle parallax illusion on scroll === */
  @media (prefers-reduced-motion: no-preference) {
    .wrap {
      perspective: 1000px;
    }

    .card {
      transform-style: preserve-3d;
    }

    body {
      background-attachment: fixed;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logo">GMC</div>
          <div>
            <div style="font-weight:800">Groupies Meme Coin</div>
            <div class="small muted">Digitalknuckles • <span id="projectUrl">digitalknuckles.xyz</span></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div id="ownerBadge" class="pill small muted" style="display:none">Owner</div>
          <div id="addrShort" class="pill small muted">Not connected</div>
          <button id="connectBtn" class="btn">Connect</button>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0" />

      <div class="grid cols-3">
        <!-- Main column: Claim + Market Watch + Activity -->
        <div>
          <div class="card" style="margin-bottom:12px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="label">Claim Center</div>
                <div class="value">Earn free GMC — Claim streaks & bonuses</div>
              </div>
              <div class="small muted">{interactive}</div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <div style="flex:1">
                <div class="label">Your balance</div>
                <div id="userBalance" class="value">—</div>
                <div class="small muted" id="userAddressFull">—</div>
              </div>

              <div style="width:180px;text-align:right">
                <div class="label">Tier</div>
                <div id="tierLabel" class="value">—</div>
                <div class="small muted">Streak days: <span id="streakDays">0</span></div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="claimBtn" class="btn" style="flex:1">Claim</button>
              <button id="depositBtn" class="btn alt" style="flex:1">Deposit for Vote</button>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              <div class="small">Next claim:</div>
              <div id="nextCountdown" class="small muted">—</div>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;padding:12px">
            <div class="label">Market Watch — Top 100 by yield</div>
            <div class="small muted">Data supplied by your backend / indexer (set LEADERBOARD_API in frontend)</div>
            <div id="leaderboard" style="margin-top:8px;max-height:260px;overflow:auto;padding-right:6px"></div>
          </div>

          <div class="card" style="padding:12px">
            <div class="label">Activity Feed</div>
            <div id="activityFeed" style="margin-top:8px;max-height:180px;overflow:auto"></div>
          </div>
        </div>

        <!-- Middle column: Voting Arena -->
        <div>
          <div class="card" style="padding:12px;margin-bottom:12px">
            <div class="label">Voting Arena</div>
            <div class="small muted">Vote with deposited GMC — owner manages events off-chain or via owner UI</div>

            <div style="margin-top:10px">
              <div class="label">Your deposited voting balance</div>
              <div id="votingDeposit" class="value">0</div>
            </div>

            <div style="margin-top:10px">
              <label class="label">Deposit amount (whole tokens)</label>
              <div style="display:flex;gap:8px;margin-top:6px">
                <input id="depositAmount" type="number" min="1" value="1" />
                <button id="doDepositBtn" class="btn">Deposit</button>
              </div>
            </div>

            <hr style="margin:10px 0;border:none;height:1px;background:rgba(255,255,255,0.02)" />

            <div class="label">Active events</div>
            <div id="voteEvents" style="margin-top:8px;max-height:360px;overflow:auto"></div>
          </div>

          <div class="card" style="padding:12px">
            <div class="label">Market Pool</div>
            <div class="small muted">Tokens deposited to the contract (voting + pool)</div>
            <div style="margin-top:8px" class="value" id="marketPool">—</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="refreshBtn" class="btn alt">Refresh</button>
              <button id="viewOnBaseScan" class="btn">View on BaseScan</button>
            </div>
          </div>
        </div>

        <!-- Right column: Contract summary & admin controls -->
        <div>
          <div class="card" style="padding:12px;margin-bottom:12px">
            <div class="label">Contract</div>
            <div style="margin-top:8px"><div class="small muted">Address</div><div id="contractAddr" class="small">0xREPLACE_WITH_YOUR_PROXY_ADDRESS</div></div>

            <div style="margin-top:8px" class="grid">
              <div class="row" style="display:flex;justify-content:space-between"><div class="small muted">Total Minted</div><div id="totalMinted" class="value">—</div></div>
              <div class="row" style="display:flex;justify-content:space-between"><div class="small muted">Public Mint</div><div id="pubMint" class="value">—</div></div>
              <div class="row" style="display:flex;justify-content:space-between"><div class="small muted">Mint price (wei)</div><div id="mintPrice" class="value">—</div></div>
              <div class="row" style="display:flex;justify-content:space-between"><div class="small muted">Market Cap (approx)</div><div id="marketCap" class="value">—</div></div>
            </div>

            <div style="margin-top:10px">
              <div class="small muted">Owner controls</div>
              <div id="adminControls" style="margin-top:8px;display:none">
                <button id="ownerMintBtn" class="btn alt">Owner Mint (ABI write)</button>
                <button id="finalizeBtn" class="btn alt">Finalize Event (owner)</button>
              </div>
            </div>
          </div>

          <div class="card" style="padding:12px">
            <div class="small muted">Quick links</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="copyAddrBtn" class="btn alt">Copy Address</button>
              <button id="exportABI" class="btn alt">Copy ABI</button>
            </div>
          </div>
        </div>

      </div>

      <div style="margin-top:10px;font-size:12px;color:rgba(255,255,255,0.6)">Designed for iframe & mini-apps. API endpoints left blank: set <code>LEADERBOARD_API</code> and <code>VOTING_API</code> to enable server-driven lists.</div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <script>
  (function(){
    // CONFIG: set these before hosting
    const CONTRACT_ADDRESS = "0xREPLACE_WITH_YOUR_PROXY_ADDRESS";
    const LEADERBOARD_API = ""; // <-- set your leaderboard backend endpoint (leave blank to disable)
    const VOTING_API = ""; // <-- optional backend to list events; if blank we'll try on-chain ids 1..N
    const RPC = "https://mainnet.base.org"; // Base mainnet RPC (change for testnet)
    document.getElementById('contractAddr').innerText = CONTRACT_ADDRESS;

    // Minimal ABI (extend if your contract differs)
    const ABI = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function totalSupply() view returns (uint256)",
      "function balanceOf(address) view returns (uint256)",
      "function getClaimInfo(address) view returns (uint256,uint256,uint8,uint8,uint8,uint256)",
      "function publicMintEnabled() view returns (bool)",
      "function mintPriceWei() view returns (uint256)",
      "function publicMint(uint256) payable",
      "function claim()",
      "function depositForVote(uint256)",
      "function voteOnEvent(uint256,uint256,bool)",
      "function getVoteEvent(uint256) view returns (uint256,string,uint256,uint256,uint256,uint256,bool,bool,uint256)",
      "function votingDeposit(address) view returns (uint256)",
      "function marketPoolBalance() view returns (uint256)",
      "function owner() view returns (address)"
    ];

    // web3modal setup
    const providerOptions = { walletconnect: { package: window.WalletConnectProvider.default, options: { rpc: { 8453: RPC }, chainId: 8453 } } };
    const web3Modal = new window.Web3Modal.default({cacheProvider:true, providerOptions});

    let provider, signer, userAddress, chainId;
    const readonlyProvider = new ethers.providers.JsonRpcProvider(RPC);
    let contractRO = new ethers.Contract(CONTRACT_ADDRESS, ABI, readonlyProvider);
    let contractRW = null;

    // DOM refs
    const connectBtn = document.getElementById('connectBtn');
    const addrShort = document.getElementById('addrShort');
    const userBalanceEl = document.getElementById('userBalance');
    const userAddressFull = document.getElementById('userAddressFull');
    const totalMintedEl = document.getElementById('totalMinted');
    const pubMintEl = document.getElementById('pubMint');
    const mintPriceEl = document.getElementById('mintPrice');
    const marketCapEl = document.getElementById('marketCap');
    const claimBtn = document.getElementById('claimBtn');
    const depositBtn = document.getElementById('depositBtn');
    const doDepositBtn = document.getElementById('doDepositBtn');
    const depositAmountInput = document.getElementById('depositAmount');
    const votingDepositEl = document.getElementById('votingDeposit');
    const voteEventsContainer = document.getElementById('voteEvents');
    const leaderboardEl = document.getElementById('leaderboard');
    const nextCountdownEl = document.getElementById('nextCountdown');
    const tierLabelEl = document.getElementById('tierLabel');
    const streakDaysEl = document.getElementById('streakDays');
    const marketPoolEl = document.getElementById('marketPool');
    const ownerBadge = document.getElementById('ownerBadge');
    const adminControls = document.getElementById('adminControls');
    const refreshBtn = document.getElementById('refreshBtn');

    // small helpers
    function short(a){ return a ? (a.slice(0,6)+"..."+a.slice(-4)) : '—'; }
    function toHuman(bn, dec){ try{return ethers.utils.formatUnits(bn, dec)}catch{return '0'} }

    async function refreshReadOnly() {
      try {
        const [name, symbol, dec, total, pubEnabled, mintPrice] = await Promise.all([
          contractRO.name().catch(()=>null),
          contractRO.symbol().catch(()=>null),
          contractRO.decimals().catch(()=>18),
          contractRO.totalSupply().catch(()=>ethers.BigNumber.from('0')),
          contractRO.publicMintEnabled().catch(()=>false),
          contractRO.mintPriceWei().catch(()=>ethers.BigNumber.from('0'))
        ]);
        const decimals = Number(dec || 18);
        totalMintedEl.innerText = toHuman(total, decimals);
        pubMintEl.innerText = pubEnabled ? 'Enabled' : 'Disabled';
        mintPriceEl.innerText = mintPrice ? mintPrice.toString() : '0';
        // market cap approx: total * mintPrice (wei*units) - this is a rough proxy, not fiat
        try{const mc = total.mul(mintPrice || ethers.BigNumber.from('0')); marketCapEl.innerText = mc.toString();}catch(e){marketCapEl.innerText='—'}

        // market pool
        const pool = await contractRO.marketPoolBalance().catch(()=>ethers.BigNumber.from('0'));
        marketPoolEl.innerText = toHuman(pool, decimals);

      } catch (err) { console.error('refreshReadOnly', err); }
    }

    async function refreshUser() {
      if (!userAddress) return;
      try {
        const dec = Number(await contractRO.decimals().catch(()=>18));
        const [bal, claimInfoRaw, deposit] = await Promise.all([
          contractRO.balanceOf(userAddress).catch(()=>ethers.BigNumber.from('0')),
          contractRO.getClaimInfo(userAddress).catch(()=>[0,0,0,0,0,0]),
          contractRO.votingDeposit(userAddress).catch(()=>ethers.BigNumber.from('0'))
        ]);
        userBalanceEl.innerText = toHuman(bal, dec);
        votingDepositEl.innerText = toHuman(deposit, dec);

        const info = { lastClaimAt: Number(claimInfoRaw[0]), nextTimeout: Number(claimInfoRaw[1]), tier: Number(claimInfoRaw[2]), claimsInCycle: Number(claimInfoRaw[3]), consecutiveDays: Number(claimInfoRaw[4]), cycleStart: Number(claimInfoRaw[5]) };
        tierLabelEl.innerText = info.tier===0? 'Claim Streak' : (info.tier===1? 'Daily Streak' : 'Max Streak');
        streakDaysEl.innerText = String(info.consecutiveDays || 0);

        if (!info.lastClaimAt || info.lastClaimAt===0) nextCountdownEl.innerText = 'Available now';
        else { const now = Math.floor(Date.now()/1000); const avail = info.lastClaimAt + info.nextTimeout; const diff = avail>now ? avail-now : 0; if(diff===0) nextCountdownEl.innerText = 'Available now'; else nextCountdownEl.innerText = Math.floor(diff/60)+'m '+(diff%60)+'s'; }

      } catch (err) { console.error('refreshUser', err); }
    }

    // leaderboard fetch (API left blank); if blank show instructions
    async function loadLeaderboard(){
      leaderboardEl.innerHTML = '';
      if (!LEADERBOARD_API) { leaderboardEl.innerHTML = '<div class="small muted">Leaderboard API not configured. Set LEADERBOARD_API in the script to load top wallets from your indexer.</div>'; return; }
      try{
        const r = await fetch(LEADERBOARD_API); if(!r.ok) throw new Error('no api'); const json = await r.json();
        const list = json.slice(0,100);
        const ol = document.createElement('ol'); ol.style.paddingLeft='18px';
        list.forEach((row,i)=>{ const li=document.createElement('li'); li.style.margin='6px 0'; li.innerHTML = `<span style="font-weight:700">${i+1}.</span> <span style="margin-left:6px">${short(row.address)}</span> — <span class="muted">${row.tokensHuman}</span>`; ol.appendChild(li); });
        leaderboardEl.appendChild(ol);
      }catch(e){ console.error('leaderboard',e); leaderboardEl.innerHTML = '<div class="small muted">Failed to load leaderboard — check your backend.</div>'; }
    }

    // load vote events: tries backend, otherwise tries on-chain ids up to N
    async function loadVoteEvents(maxIds=8){
      voteEventsContainer.innerHTML = '';
      if (VOTING_API){
        try{ const r = await fetch(VOTING_API); if(!r.ok) throw new Error('no api'); const events = await r.json(); renderEvents(events); return; }catch(e){ console.error('voting api', e); }
      }
      // on-chain fallback
      for(let id=1; id<=maxIds; id++){
        try{
          const ev = await contractRO.getVoteEvent(id);
          if (Number(ev[0])===0) continue;
          const eventObj = { id: Number(ev[0]), title: ev[1], startTime: Number(ev[2]), endTime: Number(ev[3]), yesVotes: ev[4].toString(), noVotes: ev[5].toString(), finalized: ev[6], passed: ev[7], threshold: ev[8].toString() };
          renderEventCard(eventObj);
        }catch(e){ /*ignore missing*/ }
      }
    }

    function renderEvents(events){ events.forEach(renderEventCard); }

    function renderEventCard(ev){
      const dec = 18; // show human units using contract decimals (could read dynamically)
      const card = document.createElement('div'); card.className='card'; card.style.padding='10px'; card.style.marginBottom='8px';
      const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:700">${ev.title || 'Untitled'}</div>`;
      const times = document.createElement('div'); times.className='small muted'; const now = Math.floor(Date.now()/1000);
      const state = now < ev.startTime ? 'Upcoming' : (now <= ev.endTime ? 'Live' : (ev.finalized? (ev.passed? 'PASSED':'BASHED') : 'Ended'));
      times.innerText = `${state} • ${new Date(ev.startTime*1000).toLocaleString()} — ${new Date(ev.endTime*1000).toLocaleString()}`;

      const progress = document.createElement('div'); progress.style.marginTop='8px'; progress.innerHTML = `<div class="small">Yes: ${ethers.utils.formatUnits(ev.yesVotes || '0', dec)} — No: ${ethers.utils.formatUnits(ev.noVotes || '0', dec)}</div>`;

      const controls = document.createElement('div'); controls.style.marginTop='8px'; controls.style.display='flex'; controls.style.gap='8px';
      const passBtn = document.createElement('button'); passBtn.className='btn'; passBtn.innerText='Pass'; passBtn.onclick = ()=> voteOnEvent(ev.id, 1, true);
      const bashBtn = document.createElement('button'); bashBtn.className='btn alt'; bashBtn.innerText='Bash'; bashBtn.onclick = ()=> voteOnEvent(ev.id, 1, false);
      controls.appendChild(passBtn); controls.appendChild(bashBtn);

      card.appendChild(title); card.appendChild(times); card.appendChild(progress); card.appendChild(controls);
      voteEventsContainer.appendChild(card);
    }

    // deposit workflow
    async function depositForVote(){
      try{
        if(!signer){ status('Connect wallet'); return; }
        const amt = Number(depositAmountInput.value); if(!amt || amt<=0){ status('Invalid amount'); return; }
        status('Submitting deposit...');
        const tx = await contractRW.depositForVote(amt);
        status('Deposit tx: '+tx.hash);
        await tx.wait(); status('Deposit confirmed'); await refreshUser(); loadVoteEvents();
      }catch(e){ console.error(e); status(e?.message || 'Deposit failed'); }
    }

    // vote workflow
    async function voteOnEvent(eventId, amountWhole, pass){
      try{
        if(!signer){ status('Connect wallet'); return; }
        status('Submitting vote...');
        const tx = await contractRW.voteOnEvent(eventId, amountWhole, pass);
        status('Vote tx: '+tx.hash);
        await tx.wait(); status('Vote confirmed'); await refreshUser(); loadVoteEvents();
      }catch(e){ console.error(e); status(e?.message || 'Vote failed'); }
    }

    function status(t){ document.getElementById('statusText')?.remove(); const el=document.createElement('div'); el.id='statusText'; el.style.marginTop='8px'; el.className='small muted'; el.innerText=t; document.querySelector('.wrap .card').appendChild(el); }

    // claim action
    async function doClaim(){ if(!signer){ status('Connect wallet'); return; } try{ status('Claiming...'); const tx = await contractRW.claim({gasLimit:300000}); status('Tx: '+tx.hash); await tx.wait(); status('Claim confirmed'); await refreshUser(); }catch(e){ console.error(e); status(e?.message || 'Claim failed'); } }

    // connect/disconnect handlers
    async function connect(){
      try{
        const instance = await web3Modal.connect(); provider = new ethers.providers.Web3Provider(instance); signer = provider.getSigner(); userAddress = await signer.getAddress(); chainId = (await provider.getNetwork()).chainId; contractRW = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        addrShort.innerText = short(userAddress); userAddressFull.innerText = userAddress; connectBtn.innerText='Connected';
        // owner check
        const owner = await contractRO.owner().catch(()=>null);
        if (owner && owner.toLowerCase()===userAddress.toLowerCase()){ ownerBadge.style.display='inline-block'; adminControls.style.display='block'; }
        await refreshUser();
        // subscribe
        if (instance.on){ instance.on('accountsChanged', (accs)=>{ if(!accs.length) disconnect(); else { userAddress=accs[0]; addrShort.innerText=short(userAddress); userAddressFull.innerText=userAddress; refreshUser(); } }); instance.on('chainChanged', ()=>window.location.reload()); }
      }catch(e){ console.error('connect',e); status('Connect failed'); }
    }
    async function disconnect(){ try{ await web3Modal.clearCachedProvider(); }catch(e){} provider=signer=userAddress=null; addrShort.innerText='Not connected'; userAddressFull.innerText=''; connectBtn.innerText='Connect'; ownerBadge.style.display='none'; adminControls.style.display='none'; }

    // event listeners
    connectBtn.addEventListener('click', ()=>{ if(!provider) connect(); else disconnect(); });
    doDepositBtn.addEventListener('click', depositForVote);
    claimBtn.addEventListener('click', doClaim);
    refreshBtn.addEventListener('click', async ()=>{ status('Refreshing...'); await refreshReadOnly(); if(userAddress) await refreshUser(); status('Refreshed'); });
    document.getElementById('viewOnBaseScan').addEventListener('click', ()=> window.open('https://basescan.org/address/'+CONTRACT_ADDRESS, '_blank'));
    document.getElementById('exportABI').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(JSON.stringify(ABI,null,2)); alert('ABI copied'); }catch(e){ alert('copy failed') } });

    // initial load
    (async function(){ await refreshReadOnly(); await loadLeaderboard(); await loadVoteEvents(6); setInterval(()=>{ refreshReadOnly(); if(userAddress) refreshUser(); },20000); })();

    // expose for debugging
    window.GMCMini = { refreshReadOnly, refreshUser, loadLeaderboard, loadVoteEvents };
  })();
  </script>
  <script>
/* === Liquid Glass Depth Motion System === */
(() => {
  const wrap = document.querySelector('.wrap');
  const cards = document.querySelectorAll('.card');

  // Smooth motion values
  let mouseX = 0, mouseY = 0;
  let targetX = 0, targetY = 0;

  // Mouse-based parallax
  document.addEventListener('mousemove', e => {
    const { innerWidth: w, innerHeight: h } = window;
    targetX = (e.clientX - w / 2) / w;
    targetY = (e.clientY - h / 2) / h;
  });

  // Optional: device tilt support
  window.addEventListener('deviceorientation', e => {
    const { gamma, beta } = e; // x and y tilt
    targetX = gamma / 45;
    targetY = beta / 45;
  });

  // Animate subtle parallax on cards
  function animate() {
    mouseX += (targetX - mouseX) * 0.08;
    mouseY += (targetY - mouseY) * 0.08;

    cards.forEach((card, i) => {
      const depth = (i % 3) * 0.6 + 1; // vary per layer
      const rotateX = mouseY * 4 / depth;
      const rotateY = -mouseX * 4 / depth;
      card.style.transform = `
        perspective(1000px)
        rotateX(${rotateX}deg)
        rotateY(${rotateY}deg)
        translateZ(0)
      `;
    });

    requestAnimationFrame(animate);
  }

  animate();
})();
</script>
</body>
</html>

